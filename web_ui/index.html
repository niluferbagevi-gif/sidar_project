<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SÄ°DAR â€” YazÄ±lÄ±m MÃ¼hendisi AI</title>

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0a0f;
      --bg2:       #111118;
      --bg3:       #1a1a24;
      --bg4:       #22222e;
      --border:    #2a2a38;
      --border2:   #3a3a4e;
      --text:      #e2e4f0;
      --text-dim:  #6b6d82;
      --text-muted:#4a4c60;
      --accent:    #a78bfa;
      --accent2:   #7c3aed;
      --green:     #34d399;
      --red:       #f87171;
      --yellow:    #fbbf24;
      --user-bg:   #1a1a2e;
      --sidar-bg:  #111118;
      --radius:    10px;
      --radius-lg: 16px;
    }

    /* â”€â”€ AÃ§Ä±k tema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    [data-theme="light"] {
      --bg:        #f5f5fb;
      --bg2:       #ffffff;
      --bg3:       #ebebf5;
      --bg4:       #e0e0ee;
      --border:    #d8d8e8;
      --border2:   #c0c0d4;
      --text:      #1a1a2e;
      --text-dim:  #5a5a7a;
      --text-muted:#9090b0;
      --accent:    #7c3aed;
      --accent2:   #6d28d9;
      --green:     #059669;
      --red:       #dc2626;
      --yellow:    #d97706;
      --user-bg:   #eeeef8;
      --sidar-bg:  #f5f5fb;
    }
    [data-theme="light"] .msg-body :not(pre) > code { color: var(--accent2); }
    [data-theme="light"] .msg-body pre { background: #f0f0f8 !important; }
    [data-theme="light"] .streaming-text { color: var(--text); }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    /* â”€â”€ Ana dÃ¼zen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* â”€â”€ Ãœst bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      flex-shrink: 0;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 11px;
      color: #fff;
      letter-spacing: -0.5px;
      flex-shrink: 0;
    }

    .logo-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .topbar-divider {
      width: 1px;
      height: 18px;
      background: var(--border2);
    }

    .nav-tabs {
      display: flex;
      gap: 2px;
    }

    .nav-tab {
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      transition: color .15s, background .15s;
      border: none;
      background: transparent;
      font-family: inherit;
    }
    .nav-tab:hover  { color: var(--text); background: var(--bg3); }
    .nav-tab.active { color: var(--text); background: var(--bg3); }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      padding: 5px 12px;
      border: 1px solid var(--border2);
      background: transparent;
      color: var(--text-dim);
      border-radius: 7px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: border-color .15s, color .15s, background .15s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,58,237,.08); }
    .btn-ghost.danger:hover { border-color: var(--red); color: var(--red); background: rgba(248,113,113,.08); }

    /* â”€â”€ Ana Ä°Ã§erik TaÅŸÄ±yÄ±cÄ±sÄ± (Sidebar + Content) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ Sol Sidebar (GeÃ§miÅŸ Sohbetler) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 260px;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s;
    }

    .sidebar-header {
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }

    .btn-new-chat {
      width: 100%;
      padding: 10px;
      background: var(--accent2);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: opacity 0.15s;
    }
    .btn-new-chat:hover { opacity: 0.88; }

    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .session-list::-webkit-scrollbar { width: 4px; }
    .session-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .session-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-dim);
      margin-bottom: 3px;
      transition: background 0.15s, color 0.15s;
      gap: 6px;
    }
    .session-item:hover { background: var(--bg3); color: var(--text); }
    .session-item.active { background: rgba(124,58,237,.12); color: var(--text); border: 1px solid rgba(124,58,237,.3); }

    .session-item-title {
      font-size: 12.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      opacity: 0;
      padding: 4px;
      transition: color 0.15s;
      display: flex;
    }
    .session-item:hover .session-item-delete { opacity: 1; }
    .session-item-delete:hover { color: var(--red); }

    /* â”€â”€ Ä°Ã§erik alanÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ KarÅŸÄ±lama / GÃ¶rev tanÄ±mlama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #task-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 40px 20px;
      gap: 28px;
    }

    .task-header { text-align: center; }
    .task-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      letter-spacing: -0.3px;
    }
    .task-sub { font-size: 13px; color: var(--text-dim); }

    /* â”€â”€ GÃ¶rev kutusu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-box {
      width: 100%;
      max-width: 680px;
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 4px 32px rgba(0,0,0,.4);
      transition: border-color .2s;
    }
    .task-box:focus-within { border-color: var(--accent); box-shadow: 0 4px 32px rgba(124,58,237,.15); }

    #task-input {
      width: 100%;
      background: transparent;
      border: none;
      padding: 18px 20px 12px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      resize: none;
      min-height: 100px;
      max-height: 260px;
      outline: none;
      line-height: 1.6;
    }
    #task-input::placeholder { color: var(--text-muted); }

    .task-box-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px 14px;
      gap: 10px;
      border-top: 1px solid var(--border);
    }

    .task-selectors {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .selector-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-dim);
      transition: border-color .15s, color .15s;
      white-space: nowrap;
    }
    .selector-chip:hover { border-color: var(--border2); color: var(--text); }
    .selector-chip svg  { flex-shrink: 0; opacity: .7; }

    .selector-chip .chip-label { max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
    .chip-caret { opacity: .5; font-size: 9px; margin-left: 2px; }

    .multiplier-chip {
      padding: 5px 10px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-dim);
      cursor: default;
    }

    .btn-start {
      padding: 8px 20px;
      background: var(--accent2);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      white-space: nowrap;
      transition: opacity .15s, transform .1s;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .btn-start:hover    { opacity: .88; }
    .btn-start:active   { transform: scale(.97); }
    .btn-start:disabled { opacity: .35; cursor: not-allowed; }

    /* â”€â”€ HÄ±zlÄ± Ã¶rnekler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .quick-section { width: 100%; max-width: 680px; }
    .quick-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 10px;
    }
    .quick-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .quick-chip {
      padding: 6px 12px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      color: var(--text-dim);
      transition: border-color .15s, color .15s, background .15s;
    }
    .quick-chip:hover { border-color: var(--accent); color: var(--text); background: rgba(124,58,237,.06); }

    /* â”€â”€ Sohbet alanÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-panel {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar       { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* â”€â”€ Mesaj balonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .message {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      animation: fadeIn .16s ease;
      max-width: 100%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0);   }
    }

    .message-user  { background: var(--bg2); }
    .message-sidar { background: var(--bg); }

    .msg-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
    }

    .msg-avatar {
      width: 22px;
      height: 22px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .avatar-user  { background: var(--bg4); color: var(--text-dim); }
    .avatar-sidar { background: linear-gradient(135deg, var(--accent2), var(--accent)); color: #fff; }

    .msg-body { color: var(--text); word-break: break-word; max-width: 800px; }
    .msg-body p              { margin-bottom: 10px; }
    .msg-body p:last-child   { margin-bottom: 0; }
    .msg-body h1,.msg-body h2,.msg-body h3 { margin: 14px 0 6px; color: var(--text); }
    .msg-body ul,.msg-body ol { padding-left: 22px; margin: 6px 0; }
    .msg-body li             { margin: 3px 0; }
    .msg-body a              { color: var(--accent); text-decoration: none; }
    .msg-body a:hover        { text-decoration: underline; }
    .msg-body blockquote {
      border-left: 3px solid var(--border2);
      padding-left: 12px;
      color: var(--text-dim);
      margin: 8px 0;
    }
    .msg-body :not(pre) > code {
      background: var(--bg4);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12.5px;
      color: var(--accent);
    }
    .msg-body pre {
      background: var(--bg3) !important;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      overflow-x: auto;
      margin: 10px 0;
    }
    .msg-body pre code {
      background: transparent !important;
      padding: 0;
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12.5px;
      color: var(--text);
    }
    .msg-body table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      font-size: 13px;
    }
    .msg-body th, .msg-body td { border: 1px solid var(--border); padding: 6px 12px; text-align: left; }
    .msg-body th { background: var(--bg3); color: var(--text-dim); }

    .streaming-text {
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text);
    }

    .cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--accent);
      margin-left: 1px;
      vertical-align: text-bottom;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* â”€â”€ Alt girdi (sohbet modunda) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-footer {
      border-top: 1px solid var(--border);
      background: var(--bg2);
      padding: 12px 20px 14px;
      flex-shrink: 0;
    }
    .chat-input-wrap { max-width: 860px; margin: 0 auto; }
    .chat-input-box {
      display: flex;
      align-items: flex-end;
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      gap: 8px;
      padding: 8px 10px;
      transition: border-color .15s;
    }
    .chat-input-box:focus-within { border-color: var(--accent); }

    #input-area {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 26px;
      max-height: 180px;
      overflow-y: auto;
      outline: none;
      line-height: 1.5;
      padding: 2px 0;
    }
    #input-area::placeholder { color: var(--text-muted); }

    #send-btn {
      padding: 6px 16px;
      background: var(--accent2);
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      white-space: nowrap;
      height: 32px;
      transition: opacity .15s;
      flex-shrink: 0;
    }
    #send-btn:hover    { opacity: .85; }
    #send-btn:disabled { opacity: .35; cursor: not-allowed; }

    .chat-hint { margin-top: 6px; font-size: 11px; color: var(--text-muted); text-align: center; }

    /* â”€â”€ Modallar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-bg.open { display: flex; }

    .modal-box {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-lg);
      padding: 0;
      max-width: 480px;
      width: 92%;
      box-shadow: 0 16px 64px rgba(0,0,0,.6);
      overflow: hidden;
    }

    .modal-header {
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-search {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 7px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color .15s;
    }
    .modal-search:focus { border-color: var(--accent); }
    .modal-search::placeholder { color: var(--text-muted); }

    .modal-close-btn {
      background: transparent;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      border-radius: 6px;
      transition: color .15s, background .15s;
    }
    .modal-close-btn:hover { color: var(--text); background: var(--bg3); }

    .repo-list { max-height: 320px; overflow-y: auto; padding: 8px; }
    .repo-list::-webkit-scrollbar { width: 4px; }
    .repo-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .repo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .12s;
    }
    .repo-item:hover { background: var(--bg3); }
    .repo-item.selected { background: rgba(124,58,237,.15); }

    .repo-item-icon {
      width: 32px;
      height: 32px;
      background: var(--bg4);
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 14px;
    }
    .repo-item-info { flex: 1; min-width: 0; }
    .repo-item-name { font-size: 13px; color: var(--text); font-weight: 500; }
    .repo-item-meta { font-size: 11px; color: var(--text-dim); margin-top: 1px; }

    .repo-item-check { color: var(--accent); font-size: 15px; opacity: 0; transition: opacity .12s; }
    .repo-item.selected .repo-item-check { opacity: 1; }

    /* â”€â”€ Durum modalÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-modal-box {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-lg);
      padding: 22px;
      max-width: 440px;
      width: 92%;
      box-shadow: 0 16px 64px rgba(0,0,0,.6);
    }
    .stat-modal-box h3 { font-size: 14px; margin-bottom: 14px; font-weight: 600; }

    .stat-grid { display: grid; gap: 5px; }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 12px;
      background: var(--bg3);
      border-radius: 7px;
      font-size: 12.5px;
    }
    .stat-label { color: var(--text-dim); }
    .stat-val   { color: var(--text); font-weight: 500; }
    .ok   { color: var(--green); }
    .warn { color: var(--yellow); }

    .modal-footer { padding: 12px 20px; border-top: 1px solid var(--border); }
    .btn-modal-action {
      padding: 7px 16px;
      border: 1px solid var(--border2);
      background: transparent;
      color: var(--text-dim);
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: border-color .15s, color .15s;
    }
    .btn-modal-action:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Kod bloÄŸu kopyala butonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .code-wrap { position: relative; }
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 3px 8px;
      background: var(--bg4);
      border: 1px solid var(--border2);
      border-radius: 5px;
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
      opacity: 0;
      transition: opacity .15s, color .15s, border-color .15s;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .code-wrap:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
    .copy-btn.copied { color: var(--green); border-color: var(--green); opacity: 1; }

    /* â”€â”€ Streaming durdur butonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #stop-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid var(--red);
      color: var(--red);
      border-radius: 7px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      white-space: nowrap;
      height: 32px;
      flex-shrink: 0;
      display: none;
      align-items: center;
      gap: 5px;
      transition: background .15s;
    }
    #stop-btn:hover { background: rgba(248,113,113,.1); }

    /* â”€â”€ Dosya ekle butonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .attach-label {
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      padding: 4px 6px;
      border-radius: 6px;
      transition: color .15s, background .15s;
      flex-shrink: 0;
    }
    .attach-label:hover { color: var(--accent); background: rgba(124,58,237,.08); }

    /* â”€â”€ Oturum arama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .session-search-wrap { padding: 8px 0 0; }
    .session-search {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      outline: none;
      transition: border-color .15s;
    }
    .session-search:focus { border-color: var(--accent); }
    .session-search::placeholder { color: var(--text-muted); }

    /* â”€â”€ Sidebar Meta AlanÄ± (model, auto-accept, repo, branch) â”€â”€ */
    .sidebar-meta {
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .model-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      background: rgba(124,58,237,.13);
      border: 1px solid rgba(124,58,237,.3);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: .2px;
      white-space: nowrap;
    }

    .auto-accept-wrap {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-dim);
      margin-left: auto;
      white-space: nowrap;
    }
    .auto-accept-wrap input[type="checkbox"] {
      accent-color: var(--accent2);
      width: 12px;
      height: 12px;
      cursor: pointer;
    }
    .auto-accept-wrap:hover { color: var(--text); }

    .context-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-dim);
      cursor: pointer;
      transition: border-color .15s, color .15s;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .context-chip:hover { border-color: var(--border2); color: var(--text); }

    .tag-chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      background: rgba(124,58,237,.1);
      border: 1px solid rgba(124,58,237,.25);
      border-radius: 20px;
      font-size: 10px;
      color: var(--accent);
      font-weight: 500;
      letter-spacing: .3px;
    }

    /* â”€â”€ Oturum item meta bilgisi (diff stats + zaman) â”€â”€â”€â”€â”€â”€â”€ */
    .session-item-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .session-item-stats {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
    }

    .diff-add { color: var(--green); font-weight: 600; }
    .diff-del { color: var(--red);   font-weight: 600; }
    .session-time {
      color: var(--text-muted);
      font-size: 10px;
      margin-left: auto;
    }

    /* â”€â”€ PR Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pr-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 14px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      gap: 10px;
    }

    .pr-info {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-dim);
      min-width: 0;
      overflow: hidden;
    }

    .pr-base-branch {
      color: var(--text);
      font-weight: 600;
    }

    .pr-arrow {
      color: var(--text-muted);
      font-size: 14px;
    }

    .pr-head-branch {
      color: var(--accent);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .pr-view-btn {
      padding: 3px 10px;
      background: transparent;
      border: 1px solid var(--border2);
      border-radius: 6px;
      color: var(--text-dim);
      font-size: 11px;
      font-weight: 500;
      text-decoration: none;
      white-space: nowrap;
      flex-shrink: 0;
      transition: border-color .15s, color .15s, background .15s;
    }
    .pr-view-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,58,237,.08); }

    /* â”€â”€ Input footer (model chip + auto-accept + hint) â”€â”€â”€â”€â”€â”€ */
    .input-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      gap: 10px;
    }

    .input-meta-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .model-chip-sm {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      background: rgba(124,58,237,.1);
      border: 1px solid rgba(124,58,237,.2);
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
      cursor: default;
    }

    .auto-accept-sm {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-size: 10px;
      color: var(--text-muted);
    }
    .auto-accept-sm input[type="checkbox"] {
      accent-color: var(--accent2);
      width: 11px;
      height: 11px;
      cursor: pointer;
    }
    .auto-accept-sm:hover { color: var(--text-dim); }

    /* â”€â”€ Mesaj aksiyon butonlarÄ± (dÃ¼zenle/kopyala) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .msg-actions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity .15s;
    }
    .message:hover .msg-actions { opacity: 1; }
    .msg-action-btn {
      padding: 3px 8px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
      font-family: inherit;
      transition: color .15s, border-color .15s, background .15s;
    }
    .msg-action-btn:hover { color: var(--accent); border-color: var(--accent); background: rgba(124,58,237,.07); }

    /* â”€â”€ Tema & kÄ±sayol butonlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-icon {
      padding: 5px 8px;
      border: 1px solid var(--border2);
      background: transparent;
      color: var(--text-dim);
      border-radius: 7px;
      cursor: pointer;
      font-size: 14px;
      transition: border-color .15s, color .15s, background .15s;
      line-height: 1;
      display: flex;
      align-items: center;
    }
    .btn-icon:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,58,237,.08); }

    /* â”€â”€ KÄ±sayollar modalÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shortcuts-modal-box {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-lg);
      padding: 22px;
      max-width: 420px;
      width: 92%;
      box-shadow: 0 16px 64px rgba(0,0,0,.6);
    }
    .shortcuts-modal-box h3 {
      font-size: 14px;
      margin-bottom: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .shortcut-section { margin-bottom: 14px; }
    .shortcut-section-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: var(--bg3);
      border-radius: 6px;
      margin-bottom: 3px;
      font-size: 12.5px;
    }
    .shortcut-key {
      display: flex;
      gap: 4px;
    }
    .kbd {
      background: var(--bg4);
      border: 1px solid var(--border2);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      font-family: "JetBrains Mono", monospace;
      color: var(--accent);
    }
    .shortcut-desc { color: var(--text-dim); }

    /* â”€â”€ Ekli dosya chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .attached-file {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--bg4);
      border: 1px solid var(--border2);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-dim);
      margin: 0 0 6px;
      max-width: 300px;
    }
    .attached-file-remove {
      cursor: pointer;
      color: var(--text-muted);
      margin-left: auto;
      font-size: 14px;
      line-height: 1;
      background: none;
      border: none;
      padding: 0 2px;
    }
    .attached-file-remove:hover { color: var(--red); }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      .sidebar { display: none; /* Mobilde gizle */ }
    }
    @media (max-width: 560px) {
      .nav-tabs { display: none; }
      .task-title { font-size: 18px; }
      #task-panel { padding: 28px 16px; }
      .message { padding: 12px 16px; }
    }
  </style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div class="topbar-left">
      <div class="logo-icon">SI</div>
      <span class="logo-name">SÄ°DAR</span>
      <div class="topbar-divider"></div>
      <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showTaskPanel()">GÃ¶revler</button>
        <button class="nav-tab" onclick="showChatPanel()">Sohbet</button>
      </nav>
    </div>
    <div class="topbar-right">
      <button class="btn-icon" id="theme-btn" onclick="toggleTheme()" title="Tema deÄŸiÅŸtir">ğŸŒ™</button>
      <button class="btn-icon" onclick="openShortcuts()" title="Klavye kÄ±sayollarÄ±">âŒ¨</button>
      <button class="btn-ghost" onclick="openStatus()">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M6 4v2.5L7.5 8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" fill="none"/></svg>
        Durum
      </button>
      <button class="btn-ghost danger" onclick="clearMemory()">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor" opacity=".7"><path d="M4.5 1.5h3a.5.5 0 0 1 .5.5v.5h2a.5.5 0 0 1 0 1H2a.5.5 0 0 1 0-1h2V2a.5.5 0 0 1 .5-.5zM3 5l.5 5h5l.5-5H3z"/></svg>
        Temizle
      </button>
    </div>
  </div>

  <div class="main-wrapper">

    <div class="sidebar">
      <!-- Meta bilgi alanÄ±: model, repo, branch -->
      <div class="sidebar-meta">
        <div class="meta-row">
          <span class="model-chip" id="sidebar-model-chip">
            <svg width="9" height="9" viewBox="0 0 12 12" fill="currentColor"><path d="M6 0L7.5 4.5H12L8.25 7.25L9.75 12L6 9.25L2.25 12L3.75 7.25L0 4.5H4.5Z"/></svg>
            <span id="model-name-label">YÃ¼kleniyorâ€¦</span>
          </span>
        </div>
        <div class="meta-row">
          <div class="context-chip" onclick="openRepoModal()" title="Depo seÃ§">
            ğŸ“ <span id="sidebar-repo-label">sidar_project</span>
          </div>
          <div class="context-chip" onclick="openBranchModal()" title="Dal seÃ§">
            â‡ <span id="sidebar-branch-label">main</span>
          </div>
        </div>
      </div>

      <!-- Yeni sohbet + Arama -->
      <div class="sidebar-header">
        <button class="btn-new-chat" onclick="createNewSession()">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
            <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
          </svg>
          Yeni Sohbet
        </button>
        <div class="session-search-wrap">
          <input class="session-search" id="session-search" type="text"
            placeholder="Sohbetlerde araâ€¦"
            oninput="filterSessions(this.value)" />
        </div>
      </div>
      <div class="session-list" id="session-list"></div>
    </div>

    <div class="content">

      <div id="task-panel">
        <div class="task-header">
          <div class="task-title">Sidar'a bir gÃ¶rev ver</div>
          <div class="task-sub">YazÄ±lÄ±m MimarÄ± &amp; BaÅŸ MÃ¼hendis AI</div>
        </div>

        <div class="task-box">
          <textarea id="task-input" placeholder="Bir gÃ¶revi tanÄ±mla..." rows="4"></textarea>
          <div class="task-box-footer">
            <div class="task-selectors">
              <div class="selector-chip" onclick="openRepoModal()" title="Depo seÃ§">
                <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8V1.5Z"/>
                </svg>
                <span class="chip-label" id="repo-label">niluferbagevi-gif/sidar_project</span>
                <span class="chip-caret">â–¾</span>
              </div>
              <div class="selector-chip" onclick="openBranchModal()" title="Dal seÃ§">
                <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M11.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25.75a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM3.5 3.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Z"/>
                </svg>
                <span class="chip-label" id="branch-label">main</span>
                <span class="chip-caret">â–¾</span>
              </div>
            </div>

            <button class="btn-start" onclick="startTask()">
              <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM6.5 5.25v5.5L11 8 6.5 5.25Z"/></svg>
              BaÅŸlat
            </button>
          </div>
        </div>

        <div class="quick-section">
          <div class="quick-label">HÄ±zlÄ± gÃ¶revler</div>
          <div class="quick-grid">
            <button class="quick-chip" onclick="quickTask('Proje dizinini listele ve yapÄ±yÄ± aÃ§Ä±kla')">Dizini listele</button>
            <button class="quick-chip" onclick="quickTask('Sistem saÄŸlÄ±k raporu ver')">Sistem saÄŸlÄ±ÄŸÄ±</button>
            <button class="quick-chip" onclick="quickTask('Projeyi denetle ve hatalarÄ± raporla')">Proje denetimi</button>
            <button class="quick-chip" onclick="quickTask('Son 10 commit\'i listele')">Son commitler</button>
            <button class="quick-chip" onclick="quickTask('web\'de ara: Python async best practices 2025')">Web aramasÄ±</button>
            <button class="quick-chip" onclick="quickTask('pypi: fastapi')">PyPI bilgisi</button>
            <button class="quick-chip" onclick="quickTask('EriÅŸim seviyesi ve gÃ¼venlik durumunu gÃ¶ster')">GÃ¼venlik durumu</button>
            <button class="quick-chip" onclick="quickTask('Belge deposunu listele')">RAG belgeler</button>
          </div>
        </div>
      </div>

      <div id="chat-panel">
        <div id="messages"></div>
        <div class="chat-footer">
          <div class="chat-input-wrap">

            <!-- PR / Git Dal Ã‡ubuÄŸu -->
            <div class="pr-bar" id="pr-bar" style="display:none">
              <div class="pr-info">
                <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor" style="flex-shrink:0">
                  <path d="M11.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25.75a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM3.5 3.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Z"/>
                </svg>
                <span class="pr-base-branch" id="pr-base">main</span>
                <span class="pr-arrow">â†</span>
                <span class="pr-head-branch" id="pr-head">claude/branch</span>
              </div>
              <a class="pr-view-btn" id="pr-view-btn" href="#" target="_blank">View PR</a>
            </div>

            <div id="attached-file-preview"></div>
            <div class="chat-input-box">
              <label class="attach-label" title="Dosya ekle (metin/kod)">
                <svg width="15" height="15" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/>
                </svg>
                <input type="file" id="file-input" style="display:none"
                  accept=".txt,.md,.py,.js,.ts,.json,.yaml,.yml,.toml,.csv,.html,.css,.sh,.go,.rs,.java,.c,.cpp"
                  onchange="handleFileAttach(event)" />
              </label>
              <textarea id="input-area" placeholder="Sidar'a bir ÅŸey sorâ€¦" rows="1"></textarea>
              <button id="stop-btn" onclick="stopStreaming()" title="YanÄ±tÄ± durdur">
                <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><rect width="10" height="10" rx="2"/></svg>
                Durdur
              </button>
              <button id="send-btn" onclick="sendMessage()">GÃ¶nder</button>
            </div>

            <!-- Input footer: model chip + ipucu -->
            <div class="input-footer">
              <div class="input-meta-left">
                <span class="model-chip-sm" id="input-model-chip">
                  <svg width="8" height="8" viewBox="0 0 12 12" fill="currentColor"><path d="M6 0L7.5 4.5H12L8.25 7.25L9.75 12L6 9.25L2.25 12L3.75 7.25L0 4.5H4.5Z"/></svg>
                  <span id="input-model-label">YÃ¼kleniyorâ€¦</span>
                </span>
              </div>
              <div class="chat-hint" style="margin:0">
                <span>Enter â†’ gÃ¶nder</span>&nbsp;Â·&nbsp;
                <span>Shift+Enter â†’ yeni satÄ±r</span>&nbsp;Â·&nbsp;
                <span onclick="openShortcuts()" style="cursor:pointer;text-decoration:underline">âŒ¨ kÄ±sayollar</span>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div></div></div><div class="modal-bg" id="repo-modal" onclick="modalBgClose(event,'repo-modal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <svg width="15" height="15" viewBox="0 0 16 16" fill="var(--text-dim)"><path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8V1.5Z"/></svg>
      <input class="modal-search" id="repo-search" type="text" placeholder="Depo ara..." oninput="filterRepos(this.value)" />
      <button class="modal-close-btn" onclick="closeModal('repo-modal')">âœ•</button>
    </div>
    <div class="repo-list" id="repo-list"></div>
  </div>
</div>

<div class="modal-bg" id="branch-modal" onclick="modalBgClose(event,'branch-modal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <svg width="15" height="15" viewBox="0 0 16 16" fill="var(--text-dim)"><path d="M11.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25.75a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM3.5 3.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Z"/></svg>
      <input class="modal-search" id="branch-search" type="text" placeholder="Dal ara..." oninput="filterBranches(this.value)" />
      <button class="modal-close-btn" onclick="closeModal('branch-modal')">âœ•</button>
    </div>
    <div class="repo-list" id="branch-list"></div>
  </div>
</div>

<div class="modal-bg" id="status-modal" onclick="modalBgClose(event,'status-modal')">
  <div class="stat-modal-box" onclick="event.stopPropagation()">
    <h3>Sistem Durumu</h3>
    <div class="stat-grid" id="stat-grid"><div class="stat-row"><span class="stat-label">YÃ¼kleniyorâ€¦</span></div></div>
    <div class="modal-footer"><button class="btn-modal-action" onclick="closeModal('status-modal')">Kapat</button></div>
  </div>
</div>

<div class="modal-bg" id="shortcuts-modal" onclick="modalBgClose(event,'shortcuts-modal')">
  <div class="shortcuts-modal-box" onclick="event.stopPropagation()">
    <h3>âŒ¨ Klavye KÄ±sayollarÄ±</h3>
    <div class="shortcut-section">
      <div class="shortcut-section-title">MesajlaÅŸma</div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Enter</span></div>
        <span class="shortcut-desc">Mesaj gÃ¶nder</span>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Shift</span><span class="kbd">Enter</span></div>
        <span class="shortcut-desc">Yeni satÄ±r ekle</span>
      </div>
    </div>
    <div class="shortcut-section">
      <div class="shortcut-section-title">ArayÃ¼z</div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Esc</span></div>
        <span class="shortcut-desc">ModalÄ± kapat / Streaming durdur</span>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Ctrl</span><span class="kbd">K</span></div>
        <span class="shortcut-desc">Yeni sohbet baÅŸlat</span>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Ctrl</span><span class="kbd">L</span></div>
        <span class="shortcut-desc">BelleÄŸi temizle</span>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Alt</span><span class="kbd">T</span></div>
        <span class="shortcut-desc">Tema deÄŸiÅŸtir (koyu/aÃ§Ä±k)</span>
      </div>
    </div>
    <div class="shortcut-section">
      <div class="shortcut-section-title">Kod BloklarÄ±</div>
      <div class="shortcut-row">
        <div class="shortcut-key"><span class="kbd">Kopyala</span></div>
        <span class="shortcut-desc">Kod bloÄŸunun Ã¼zerine gel â†’ buton gÃ¶rÃ¼nÃ¼r</span>
      </div>
    </div>
    <div class="modal-footer" style="padding:12px 0 0; border-top:1px solid var(--border); margin-top:4px;">
      <button class="btn-modal-action" onclick="closeModal('shortcuts-modal')">Kapat</button>
    </div>
  </div>
</div>

<script>
marked.setOptions({ breaks: true, gfm: true });

/* â”€â”€â”€ DeÄŸiÅŸkenler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let isStreaming    = false;
let msgCounter     = 0;
let activeController = null;
let currentRepo    = 'niluferbagevi-gif/sidar_project';
let currentBranch  = 'main';
let currentSessionId = null;
let attachedFileContent = null;
let attachedFileName    = null;
let allSessions = [];

const REPOS = [
  { name: 'niluferbagevi-gif/sidar_project', desc: 'YazÄ±lÄ±m MÃ¼hendisi AI', emoji: 'ğŸ¤–' },
  { name: 'niluferbagevi-gif/LotusAI',       desc: 'Lotus AI projesi',      emoji: 'ğŸŒ¸' },
];

const BRANCHES = ['main', 'develop', 'feature/ai-core', 'hotfix/web-ui'];

/* â”€â”€â”€ Tema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  const next = isDark ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('sidar-theme', next);
  document.getElementById('theme-btn').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€';
}

function applyStoredTheme() {
  const saved = localStorage.getItem('sidar-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  const btn = document.getElementById('theme-btn');
  if (btn) btn.textContent = saved === 'dark' ? 'ğŸŒ™' : 'â˜€';
}

/* â”€â”€â”€ Model bilgisi yÃ¼kleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadModelInfo() {
  try {
    const data = await (await fetch('/status')).json();
    const provider = (data.provider || 'ollama').toLowerCase();
    const model    = data.model || 'â€”';
    const display  = provider === 'gemini' ? `Gemini Â· ${model}` : model;

    const sidebarLabel = document.getElementById('model-name-label');
    if (sidebarLabel) sidebarLabel.textContent = display;

    const inputLabel = document.getElementById('input-model-label');
    if (inputLabel) inputLabel.textContent = display;
  } catch {
    // Sessizce geÃ§
  }
}

/* â”€â”€â”€ Git bilgisi yÃ¼kleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadGitInfo() {
  try {
    const data = await (await fetch('/git-info')).json();
    const branch = data.branch || 'main';
    const repo   = data.repo   || '';

    // Global deÄŸiÅŸkenleri gerÃ§ek git bilgisiyle doldur
    currentBranch = branch;
    if (repo) currentRepo = repo;

    // Sidebar etiketleri
    const sbl = document.getElementById('sidebar-branch-label');
    if (sbl) sbl.textContent = branch;

    const srl = document.getElementById('sidebar-repo-label');
    if (srl) srl.textContent = repo.split('/').pop() || repo || 'sidar_project';

    // GÃ¶rev paneli seÃ§ici etiketleri
    const branchLabel = document.getElementById('branch-label');
    if (branchLabel) branchLabel.textContent = branch;

    const repoLabel = document.getElementById('repo-label');
    if (repoLabel && repo) repoLabel.textContent = repo;

    // PR Ã‡ubuÄŸu: sadece main/master dÄ±ÅŸÄ± dallarda gÃ¶ster
    const prBar = document.getElementById('pr-bar');
    if (prBar && branch && branch !== 'main' && branch !== 'master') {
      document.getElementById('pr-base').textContent = 'main';
      document.getElementById('pr-head').textContent = branch;
      const viewBtn = document.getElementById('pr-view-btn');
      if (viewBtn && repo) {
        viewBtn.href = `https://github.com/${repo}/compare/main...${branch}`;
      }
      prBar.style.display = 'flex';
    }
  } catch (e) {
    // Git bilgisi alÄ±namazsa sessizce geÃ§
  }
}

/* â”€â”€â”€ BaÅŸlangÄ±Ã§ ve Oturumlar (Sessions) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('DOMContentLoaded', async () => {
  applyStoredTheme();
  await loadSessions();
  if (currentSessionId) {
    await loadSessionHistory(currentSessionId, false);
  }
  loadGitInfo();
  loadModelInfo();
});

async function loadSessions() {
  try {
    const res = await fetch('/sessions');
    const data = await res.json();
    currentSessionId = data.active_session;
    allSessions = data.sessions || [];
    renderSessionList(allSessions);
  } catch (err) {
    console.error("Oturumlar yÃ¼klenemedi:", err);
  }
}

function formatRelTime(ts) {
  if (!ts) return '';
  const diffSec = Math.floor((Date.now() / 1000) - ts);
  if (diffSec < 60)  return 'az Ã¶nce';
  if (diffSec < 3600) return `${Math.floor(diffSec/60)} dk Ã¶nce`;
  if (diffSec < 86400) return `${Math.floor(diffSec/3600)} sa Ã¶nce`;
  if (diffSec < 604800) return `${Math.floor(diffSec/86400)} gÃ¼n Ã¶nce`;
  return `${Math.floor(diffSec/604800)} hf Ã¶nce`;
}

function renderSessionList(sessions) {
  const listEl = document.getElementById('session-list');
  listEl.innerHTML = '';
  if (!sessions || sessions.length === 0) return;
  sessions.forEach(s => {
    const isActive = s.id === currentSessionId;
    const div = document.createElement('div');
    div.className = `session-item ${isActive ? 'active' : ''}`;
    div.onclick = () => selectSession(s.id);
    const userCount = s.user_count || 0;
    const astCount  = s.asst_count || 0;
    const relTime   = formatRelTime(s.updated_at);
    const statsHtml = (userCount > 0 || astCount > 0)
      ? `<span class="diff-add">+${userCount}</span><span class="diff-del">-${astCount}</span>`
      : '';
    div.innerHTML = `
      <div class="session-item-main">
        <div class="session-item-title" title="${escHtml(s.title)}">${escHtml(s.title)}</div>
        <div class="session-item-stats">
          ${statsHtml}
          <span class="session-time">${relTime}</span>
        </div>
      </div>
      <button class="session-item-delete" onclick="deleteSession('${s.id}', event)" title="Sohbeti Sil">
        <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor">
          <path d="M5.5 1a.5.5 0 0 0-.5.5v1h6v-1a.5.5 0 0 0-.5-.5h-5ZM2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-1v9a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2v-9h-1a.5.5 0 0 1-.5-.5Zm3 1v9a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-9H5Z"/>
        </svg>
      </button>`;
    listEl.appendChild(div);
  });
}

function filterSessions(q) {
  if (!q.trim()) {
    renderSessionList(allSessions);
    return;
  }
  const lower = q.toLowerCase();
  renderSessionList(allSessions.filter(s => s.title.toLowerCase().includes(lower)));
}

async function selectSession(id) {
  if (id === currentSessionId) {
    showChatPanel();
    return;
  }
  currentSessionId = id;
  await loadSessionHistory(id, true);
}

async function loadSessionHistory(id, switchToChat = false) {
  try {
    const res = await fetch(`/sessions/${id}`);
    const data = await res.json();
    
    if (data.success) {
      document.getElementById('messages').innerHTML = '';
      msgCounter = 0;
      
      if (data.history && data.history.length > 0) {
        data.history.forEach(msg => {
          if (msg.role === 'user') {
            appendUser(msg.content);
          } else if (msg.role === 'assistant') {
            const msgId = createSidarMsg();
            finalizeMsg(msgId, msg.content);
          }
        });
      }
      loadSessions(); // MenÃ¼deki renk vurgusunu (active) gÃ¼ncelle
      if (switchToChat) showChatPanel();
    }
  } catch (err) {
    console.error("GeÃ§miÅŸ yÃ¼klenemedi:", err);
  }
}

async function createNewSession() {
  try {
    const res = await fetch('/sessions/new', { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      currentSessionId = data.session_id;
      document.getElementById('messages').innerHTML = '';
      document.getElementById('task-input').value = '';
      document.getElementById('input-area').value = '';
      msgCounter = 0;
      await loadSessions();
      showTaskPanel();
    }
  } catch (err) {
    console.error("Yeni sohbet oluÅŸturulamadÄ±:", err);
  }
}

async function deleteSession(id, event) {
  event.stopPropagation();
  if (!confirm('Bu sohbet kalÄ±cÄ± olarak silinecek. Emin misiniz?')) return;
  try {
    const res = await fetch(`/sessions/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      if (currentSessionId === id) {
         document.getElementById('messages').innerHTML = '';
         showTaskPanel();
      }
      await loadSessions();
      if (data.active_session && currentSessionId === id) {
         currentSessionId = data.active_session;
         loadSessionHistory(currentSessionId, false);
      }
    }
  } catch (err) {
    console.error("Sohbet silinemedi:", err);
  }
}

/* â”€â”€â”€ Panel geÃ§iÅŸleri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showTaskPanel() {
  document.getElementById('task-panel').style.display = 'flex';
  document.getElementById('chat-panel').style.display = 'none';
  document.querySelectorAll('.nav-tab').forEach((t,i) => t.classList.toggle('active', i===0));
}

function showChatPanel() {
  document.getElementById('task-panel').style.display = 'none';
  document.getElementById('chat-panel').style.display = 'flex';
  document.querySelectorAll('.nav-tab').forEach((t,i) => t.classList.toggle('active', i===1));
  document.getElementById('input-area').focus();
}

/* â”€â”€â”€ GÃ¶rev baÅŸlat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startTask() {
  const text = document.getElementById('task-input').value.trim();
  if (!text) return;
  document.getElementById('task-input').value = '';
  showChatPanel();
  sendText(text);
}

function quickTask(text) {
  document.getElementById('task-input').value = text;
  startTask();
}

/* â”€â”€â”€ Textarea otomatik boyutlandÄ±rma â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
['task-input','input-area'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', () => {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, id === 'task-input' ? 260 : 180) + 'px';
  });
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      id === 'task-input' ? startTask() : sendMessage();
    }
  });
});

/* â”€â”€â”€ Streaming durdur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function stopStreaming() {
  if (activeController) activeController.abort();
}

/* â”€â”€â”€ Dosya ekleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleFileAttach(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 200 * 1024) {
    alert('Dosya boyutu 200 KB\'Ä± aÅŸamaz.');
    e.target.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = ev => {
    attachedFileContent = ev.target.result;
    attachedFileName    = file.name;
    renderAttachedFile(file.name);
  };
  reader.readAsText(file, 'utf-8');
  e.target.value = '';
}

function renderAttachedFile(name) {
  const preview = document.getElementById('attached-file-preview');
  preview.innerHTML = `
    <div class="attached-file">
      <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
        <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/>
      </svg>
      <span>${escHtml(name)}</span>
      <button class="attached-file-remove" onclick="removeAttachedFile()" title="DosyayÄ± kaldÄ±r">âœ•</button>
    </div>`;
}

function removeAttachedFile() {
  attachedFileContent = null;
  attachedFileName    = null;
  document.getElementById('attached-file-preview').innerHTML = '';
}

/* â”€â”€â”€ Mesaj gÃ¶nderme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sendMessage() {
  const textarea = document.getElementById('input-area');
  const text = textarea.value.trim();
  if (!text && !attachedFileContent) return;
  const finalText = attachedFileContent
    ? `${text}\n\n**Dosya: ${attachedFileName}**\n\`\`\`\n${attachedFileContent}\n\`\`\``
    : text;
  textarea.value = '';
  textarea.style.height = 'auto';
  removeAttachedFile();
  sendText(finalText);
}

async function sendText(text) {
  if (isStreaming) return;
  isStreaming = true;

  const sendBtn = document.getElementById('send-btn');
  const stopBtn = document.getElementById('stop-btn');
  if (sendBtn) { sendBtn.disabled = true; sendBtn.style.display = 'none'; }
  if (stopBtn) stopBtn.style.display = 'flex';

  appendUser(text);
  const msgId = createSidarMsg();

  let accumulated = '';
  activeController = new AbortController();
  let timeoutId = null;

  const resetTimeout = () => {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => activeController.abort(), 60000);
  };

  try {
    resetTimeout();
    const response = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
      signal: activeController.signal
    });

    if (!response.ok) {
      finalizeMsg(msgId, `[HTTP HatasÄ±] Sunucu ${response.status} kodu dÃ¶ndÃ¼rdÃ¼.`);
      return;
    }

    const reader  = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    let streamDone = false;
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      resetTimeout();
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const parsed = JSON.parse(line.slice(6).trim());
          if (parsed.done) { streamDone = true; break; }
          if (parsed.chunk) { accumulated += parsed.chunk; updateStreaming(msgId, accumulated); }
        } catch { /* skip */ }
      }
      if (streamDone) break;
    }
  } catch (err) {
    if (err.name === 'AbortError') {
      accumulated += accumulated ? '\n\n*[YanÄ±t durduruldu.]*' : '*[YanÄ±t durduruldu.]*';
    } else {
      accumulated += `\n\n[BaÄŸlantÄ± HatasÄ±: ${err.message}]`;
    }
  } finally {
    if (timeoutId) clearTimeout(timeoutId);
    activeController = null;
    finalizeMsg(msgId, accumulated);
    isStreaming = false;
    if (sendBtn) { sendBtn.disabled = false; sendBtn.style.display = ''; }
    if (stopBtn) stopBtn.style.display = 'none';
    loadSessions();
  }
}

/* â”€â”€â”€ Mesaj yardÄ±mcÄ±larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function escHtml(str) {
  const d = document.createElement('div');
  d.appendChild(document.createTextNode(str));
  return d.innerHTML;
}

function scrollBottom() {
  const msgs = document.getElementById('messages');
  msgs.scrollTop = msgs.scrollHeight;
}

function appendUser(text) {
  const msgs = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'message message-user';
  const safeText = escHtml(text);
  el.innerHTML = `
    <div class="msg-header">
      <div class="msg-avatar avatar-user">S</div>
      <span>Sen</span>
    </div>
    <div class="msg-body" style="white-space:pre-wrap">${safeText}</div>
    <div class="msg-actions">
      <button class="msg-action-btn" onclick="editMessage(this, ${JSON.stringify(text)})" title="DÃ¼zenle ve tekrar gÃ¶nder">
        âœ DÃ¼zenle
      </button>
      <button class="msg-action-btn" onclick="copyText(${JSON.stringify(text)}, this)" title="MesajÄ± kopyala">
        ğŸ“‹ Kopyala
      </button>
    </div>`;
  msgs.appendChild(el);
  scrollBottom();
}

function editMessage(btn, originalText) {
  // KullanÄ±cÄ± mesaj balonunu DOM'dan kaldÄ±r (tekrar gÃ¶nderiÅŸ temiz olsun)
  const msgEl = btn.closest('.message');
  if (msgEl) msgEl.remove();

  const inputArea = document.getElementById('input-area');
  inputArea.value = originalText;
  inputArea.style.height = 'auto';
  inputArea.style.height = Math.min(inputArea.scrollHeight, 180) + 'px';
  inputArea.focus();
}

function copyText(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'âœ“ KopyalandÄ±';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function createSidarMsg() {
  const msgs = document.getElementById('messages');
  const id   = `m${++msgCounter}`;
  const el   = document.createElement('div');
  el.className = 'message message-sidar';
  el.id = id;
  el.innerHTML = `
    <div class="msg-header">
      <div class="msg-avatar avatar-sidar">SI</div>
      <span>Sidar</span>
    </div>
    <div class="msg-body">
      <span class="streaming-text" id="${id}-txt"></span><span class="cursor" id="${id}-cur"></span>
    </div>`;
  msgs.appendChild(el);
  scrollBottom();
  return id;
}

function updateStreaming(id, rawText) {
  const span = document.getElementById(`${id}-txt`);
  if (span) span.textContent = rawText;
  scrollBottom();
}

function finalizeMsg(id, rawText) {
  const el = document.getElementById(id);
  if (!el) return;
  const body   = el.querySelector('.msg-body');
  const cursor = document.getElementById(`${id}-cur`);
  if (cursor) cursor.remove();
  body.innerHTML = marked.parse(rawText || '*(yanÄ±t alÄ±namadÄ±)*');
  body.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));

  // Kod bloklarÄ±na kopyala butonu ekle
  body.querySelectorAll('pre').forEach(pre => {
    const wrap = document.createElement('div');
    wrap.className = 'code-wrap';
    pre.parentNode.insertBefore(wrap, pre);
    wrap.appendChild(pre);
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg> Kopyala`;
    btn.onclick = () => {
      const code = pre.querySelector('code');
      navigator.clipboard.writeText(code ? code.innerText : pre.innerText).then(() => {
        btn.textContent = 'âœ“ KopyalandÄ±';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg> Kopyala`;
          btn.classList.remove('copied');
        }, 2000);
      });
    };
    wrap.appendChild(btn);
  });

  scrollBottom();
}

/* â”€â”€â”€ Repo ve Branch SeÃ§iciler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openRepoModal() {
  renderRepos(REPOS);
  document.getElementById('repo-search').value = '';
  document.getElementById('repo-modal').classList.add('open');
  setTimeout(() => document.getElementById('repo-search').focus(), 50);
}

function renderRepos(list) {
  document.getElementById('repo-list').innerHTML = list.map(r => `
    <div class="repo-item ${r.name === currentRepo ? 'selected' : ''}" onclick="selectRepo('${r.name}')">
      <div class="repo-item-icon">${r.emoji}</div>
      <div class="repo-item-info">
        <div class="repo-item-name">${r.name}</div>
        <div class="repo-item-meta">${r.desc}</div>
      </div>
      <span class="repo-item-check">âœ“</span>
    </div>`).join('');
}

function filterRepos(q) {
  renderRepos(REPOS.filter(r => r.name.toLowerCase().includes(q.toLowerCase())));
}

async function selectRepo(name) {
  currentRepo = name;
  document.getElementById('repo-label').textContent = name;
  const srl = document.getElementById('sidebar-repo-label');
  if (srl) srl.textContent = name.split('/').pop() || name;
  closeModal('repo-modal');

  // PR Ã§ubuÄŸu baÄŸlantÄ±sÄ±nÄ± gÃ¼ncelle
  const viewBtn = document.getElementById('pr-view-btn');
  if (viewBtn && currentBranch && currentBranch !== 'main' && currentBranch !== 'master') {
    viewBtn.href = `https://github.com/${name}/compare/main...${currentBranch}`;
  }

  // Backend'e bildir (GitHub ajan baÄŸlantÄ±sÄ±nÄ± gÃ¼ncelle)
  try {
    const res  = await fetch('/set-repo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ repo: name }),
    });
    const data = await res.json();
    if (!data.success) console.warn('Depo deÄŸiÅŸtirilemedi:', data.message);
  } catch (e) {
    console.warn('Depo API hatasÄ±:', e);
  }
}

let _cachedBranches = null;

async function openBranchModal() {
  document.getElementById('branch-search').value = '';
  document.getElementById('branch-modal').classList.add('open');

  // GerÃ§ek dal listesini sunucudan Ã§ek (oturum boyunca Ã¶nbelleÄŸe al)
  if (!_cachedBranches) {
    document.getElementById('branch-list').innerHTML =
      '<div style="padding:14px;color:var(--text-dim);font-size:12px">Dallar yÃ¼kleniyorâ€¦</div>';
    try {
      const data      = await (await fetch('/git-branches')).json();
      _cachedBranches = data.branches || ['main'];
    } catch {
      _cachedBranches = [currentBranch || 'main'];
    }
  }

  renderBranches(_cachedBranches);
  setTimeout(() => document.getElementById('branch-search').focus(), 50);
}

function renderBranches(list) {
  document.getElementById('branch-list').innerHTML = list.map(b => `
    <div class="repo-item ${b === currentBranch ? 'selected' : ''}" onclick="selectBranch('${b}')">
      <div class="repo-item-icon" style="font-size:18px">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="var(--text-dim)">
          <path d="M11.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25.75a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM3.5 3.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Z"/>
        </svg>
      </div>
      <div class="repo-item-info">
        <div class="repo-item-name">${b}</div>
      </div>
      <span class="repo-item-check">âœ“</span>
    </div>`).join('');
}

function filterBranches(q) {
  renderBranches((_cachedBranches || [currentBranch]).filter(
    b => b.toLowerCase().includes(q.toLowerCase())
  ));
}

function selectBranch(name) {
  currentBranch = name;

  // TÃ¼m etiketleri gÃ¼ncelle
  document.getElementById('branch-label').textContent = name;
  const sbl = document.getElementById('sidebar-branch-label');
  if (sbl) sbl.textContent = name;

  // PR Ã§ubuÄŸunu gÃ¼ncelle
  const prBar = document.getElementById('pr-bar');
  if (prBar) {
    if (name && name !== 'main' && name !== 'master') {
      document.getElementById('pr-head').textContent = name;
      const viewBtn = document.getElementById('pr-view-btn');
      if (viewBtn && currentRepo) {
        viewBtn.href = `https://github.com/${currentRepo}/compare/main...${name}`;
      }
      prBar.style.display = 'flex';
    } else {
      prBar.style.display = 'none';
    }
  }

  closeModal('branch-modal');
}

/* â”€â”€â”€ Modal yardÄ±mcÄ±larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function modalBgClose(e, id) {
  if (e.target === document.getElementById(id)) closeModal(id);
}

/* â”€â”€â”€ Durum modalÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openStatus() {
  document.getElementById('status-modal').classList.add('open');
  const grid = document.getElementById('stat-grid');
  grid.innerHTML = '<div class="stat-row"><span class="stat-label">YÃ¼kleniyorâ€¦</span></div>';
  try {
    const data = await (await fetch('/status')).json();
    const row = (label, value, cls='') =>
      `<div class="stat-row">
        <span class="stat-label">${label}</span>
        <span class="stat-val ${cls}">${value}</span>
      </div>`;

    // GPU satÄ±rlarÄ±nÄ± oluÅŸtur
    let gpuRows = '';
    if (data.gpu_enabled) {
      gpuRows += row('GPU', `âœ“ ${data.gpu_info || 'Aktif'}`, 'ok');
      if (data.cuda_version && data.cuda_version !== 'N/A') {
        gpuRows += row('CUDA', data.cuda_version);
      }
      if (data.gpu_count > 1) {
        gpuRows += row('GPU SayÄ±sÄ±', `${data.gpu_count} cihaz`);
      }
      (data.gpu_devices || []).forEach(d => {
        const temp  = d.temperature_c  != null ? `  ${d.temperature_c}Â°C` : '';
        const util  = d.utilization_pct != null ? `  %${d.utilization_pct}` : '';
        gpuRows += row(
          `GPU ${d.id}`,
          `${d.name} Â· ${d.allocated_gb}/${d.total_vram_gb} GB${temp}${util}`
        );
      });
    } else {
      gpuRows = row('GPU', 'âœ— CPU modu', 'warn');
    }

    grid.innerHTML = [
      row('SÃ¼rÃ¼m',           `v${data.version}`),
      row('AI SaÄŸlayÄ±cÄ±',   `${data.provider} / ${data.model}`),
      row('EriÅŸim Seviyesi', data.access_level.toUpperCase()),
      row('Bellek',          `${data.memory_count} mesaj`),
      row('GitHub',    data.github     ? 'âœ“ BaÄŸlÄ±'         : 'âœ— BaÄŸlÄ± deÄŸil', data.github     ? 'ok' : 'warn'),
      row('Web Arama', data.web_search ? 'âœ“ Aktif'         : 'âœ— Kurulu deÄŸil', data.web_search ? 'ok' : 'warn'),
      row('RAG',       data.rag_status),
      row('Paket Bilgi', 'âœ“ PyPI + npm + GitHub', 'ok'),
      gpuRows,
    ].join('');
  } catch (err) {
    grid.innerHTML = `<div class="stat-row"><span class="stat-label">BaÄŸlantÄ± hatasÄ±: ${escHtml(err.message)}</span></div>`;
  }
}

/* â”€â”€â”€ Bellek temizle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function clearMemory() {
  if (!confirm('GeÃ§erli konuÅŸma belleÄŸi (ekrandaki mesajlar) temizlenecek. Devam edilsin mi?')) return;
  try { await fetch('/clear', { method: 'POST' }); } catch { /* ignore */ }
  document.getElementById('messages').innerHTML = '';
  showTaskPanel();
  loadSessions(); // MenÃ¼yÃ¼ yenile
}

/* â”€â”€â”€ KÄ±sayollar modalÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openShortcuts() {
  document.getElementById('shortcuts-modal').classList.add('open');
}

/* â”€â”€â”€ Global klavye kÄ±sayollarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  // ESC: Modal kapat veya streaming durdur
  if (e.key === 'Escape') {
    ['repo-modal','branch-modal','status-modal','shortcuts-modal'].forEach(id => closeModal(id));
    if (isStreaming) stopStreaming();
    return;
  }
  // Aktif input/textarea iÃ§indeyken kÄ±sayollarÄ± tetikleme
  const tag = document.activeElement.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA') return;

  // Ctrl+K: Yeni sohbet
  if (e.ctrlKey && e.key === 'k') {
    e.preventDefault();
    createNewSession();
  }
  // Ctrl+L: BelleÄŸi temizle
  if (e.ctrlKey && e.key === 'l') {
    e.preventDefault();
    clearMemory();
  }
  // Alt+T: Tema deÄŸiÅŸtir (Ctrl+T tarayÄ±cÄ±da yeni sekme aÃ§ar, Alt+T Ã§akÄ±ÅŸmaz)
  if (e.altKey && e.key === 't') {
    e.preventDefault();
    toggleTheme();
  }
});
</script>
</body>
</html>